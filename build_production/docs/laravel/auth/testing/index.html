<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
        <meta http-equiv="x-ua-compatible" content="ie=edge">
        <meta name="description" content="LdapRecord-Laravel testing guide">

        <meta property="og:site_name" content="LdapRecord"/>
        <meta property="og:title" content="Testing Authentication | LdapRecord"/>
        <meta property="og:description" content="LdapRecord-Laravel testing guide"/>
        <meta property="og:url" content="https://ldaprecord.com/docs/laravel/auth/testing"/>
        <meta property="og:image" content="/assets/img/logo.png"/>
        <meta property="og:type" content="website"/>

        <meta name="twitter:image:alt" content="LdapRecord">
        <meta name="twitter:card" content="summary_large_image">

                    <meta name="generator" content="tighten_jigsaw_doc">
        
        <title>LdapRecord | Testing Authentication</title>

        <link rel="home" href="https://ldaprecord.com">
        <link rel="icon" href="/favicon.ico">
        <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
        <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
        <link rel="manifest" href="/site.webmanifest">
        <link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">
        <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
        <meta name="msapplication-TileColor" content="#da532c">
        <meta name="theme-color" content="#ffffff">

        
        <link rel="stylesheet" href="/assets/build/css/main.css?id=d151e2283f27a53e0740">

                    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/docsearch.js@2/dist/cdn/docsearch.min.css" />
            </head>
    <body class="antialiased font-sans">
        <nav class="flex items-center h-24 py-12 z-20 border-gradient-l-purple-light border-b-8 mb-2" role="banner">
            <div class="container flex items-center max-w-8xl mx-auto px-4 lg:px-8">
                <div class="flex items-center">
                    <a href="/" title="LdapRecord home" class="inline-flex items-center">
                        <img class="h-20 md:h-24 mr-3" src="/assets/img/logo.svg" alt="LdapRecord logo" />
                    </a>
                </div>

                <div class="flex flex-1 justify-end items-center text-right md:pl-10 text-gray-800">
                                            <button
    title="Start searching"
    type="button"
    class="flex md:hidden bg-gray-100 hover:bg-blue-100 justify-center items-center shadow rounded focus:outline-none h-10 px-3"
    onclick="searchInput.toggle()"
>
    <img src="/assets/img/magnifying-glass.svg" alt="search icon" class="h-4 w-4 max-w-none">
</button>

<div id="js-search-input" class="docsearch-input__wrapper hidden md:block">
    <label for="search" class="hidden">Search</label>

    <input
        id="docsearch-input"
        class="docsearch-input block h-10 transition-fast w-full lg:w-1/2 xl:w-1/3 outline-none rounded text-gray-700 focus:border-blue-400 ml-auto px-4 pb-0 shadow"
        name="docsearch"
        type="text"
        placeholder="Search"
    >

    <button
        class="md:hidden absolute right-0 mr-8 h-full font-light text-3xl text-blue-500 hover:text-blue-600 focus:outline-none -mt-px"
        onclick="searchInput.toggle()"
    >&times;</button>
</div>

                    
                                            <a href="/docs/" class="ml-6 hidden md:inline whitespace-no-wrap text-gray-800 hover:text-purple-700" title="LdapRecord Documentation Link">
                            Core Docs
                        </a>

                        <a href="https://github.com/DirectoryTree/LdapRecord-Laravel" class="hidden text-gray-800 hover:text-purple-700 sm:inline">
                            <svg class="fill-current w-8 ml-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"><title>GitHub</title><path d="M10 0a10 10 0 0 0-3.16 19.49c.5.1.68-.22.68-.48l-.01-1.7c-2.78.6-3.37-1.34-3.37-1.34-.46-1.16-1.11-1.47-1.11-1.47-.9-.62.07-.6.07-.6 1 .07 1.53 1.03 1.53 1.03.9 1.52 2.34 1.08 2.91.83.1-.65.35-1.09.63-1.34-2.22-.25-4.55-1.11-4.55-4.94 0-1.1.39-1.99 1.03-2.69a3.6 3.6 0 0 1 .1-2.64s.84-.27 2.75 1.02a9.58 9.58 0 0 1 5 0c1.91-1.3 2.75-1.02 2.75-1.02.55 1.37.2 2.4.1 2.64.64.7 1.03 1.6 1.03 2.69 0 3.84-2.34 4.68-4.57 4.93.36.31.68.92.68 1.85l-.01 2.75c0 .26.18.58.69.48A10 10 0 0 0 10 0"></path></svg>
                        </a>
                                    </div>
            </div>

                <button class="flex justify-center items-center bg-purple-500 shadow h-10 mr-4 px-5 rounded lg:hidden focus:outline-none"
    onclick="navMenu.toggle()"
>
    <svg id="js-nav-menu-show" xmlns="http://www.w3.org/2000/svg"
        class="fill-current text-white h-9 w-4" viewBox="0 0 32 32"
    >
        <path d="M4,10h24c1.104,0,2-0.896,2-2s-0.896-2-2-2H4C2.896,6,2,6.896,2,8S2.896,10,4,10z M28,14H4c-1.104,0-2,0.896-2,2  s0.896,2,2,2h24c1.104,0,2-0.896,2-2S29.104,14,28,14z M28,22H4c-1.104,0-2,0.896-2,2s0.896,2,2,2h24c1.104,0,2-0.896,2-2  S29.104,22,28,22z"/>
    </svg>

    <svg id="js-nav-menu-hide" xmlns="http://www.w3.org/2000/svg"
        class="hidden fill-current text-white h-9 w-4" viewBox="0 0 36 30"
    >
        <polygon points="32.8,4.4 28.6,0.2 18,10.8 7.4,0.2 3.2,4.4 13.8,15 3.2,25.6 7.4,29.8 18,19.2 28.6,29.8 32.8,25.6 22.2,15 "/>
    </svg>
</button>

        </nav>

        <main role="main" class="w-full">
            <div class="relative h-full max-w-screen-xl mx-auto">
                                    <svg style="left:100%;" width="404" height="784" fill="none" viewBox="0 0 404 784" class="absolute hidden sm:block transform translate-y-64 -translate-x-64">
                        <defs>
                            <pattern id="f210dbf6-a58d-4871-961e-36d5016a0f49" x="0" y="0" width="20" height="20" patternUnits="userSpaceOnUse">
                                <rect x="0" y="0" width="4" height="4" fill="currentColor" class="text-gray-200"></rect>
                            </pattern>
                        </defs>
                        <rect width="404" height="784" fill="url(#f210dbf6-a58d-4871-961e-36d5016a0f49)"></rect>
                    </svg>
                            </div>

                <section class="container relative max-w-8xl mx-auto px-6 md:px-8 py-4">
        <div class="flex flex-col lg:flex-row">
            <nav id="js-nav-menu" class="nav-menu hidden lg:block">
                    <ul class="list-none my-0 ">
            <li class="pl-4">
            
        <p class="nav-menu__item text-gray-500 font-extrabold text-xs tracking-widest uppercase italic pt-2">Introduction</p>
    
            
        <ul class="list-none my-0 border-l-4 border-purple-200">
            <li class="pl-4">
            
        <a href="/docs/laravel/quickstart"
            class="lvl1  text-gray-700 nav-menu__item hover:text-purple-500"
        >
            Quickstart
        </a>
    
    </li>
            <li class="pl-4">
            
        <a href="/docs/laravel"
            class="lvl1  text-gray-700 nav-menu__item hover:text-purple-500"
        >
            Overview
        </a>
    
    </li>
            <li class="pl-4">
            
        <a href="/docs/laravel/installation"
            class="lvl1  text-gray-700 nav-menu__item hover:text-purple-500"
        >
            Installation
        </a>
    
    </li>
            <li class="pl-4">
            
        <a href="/docs/laravel/usage"
            class="lvl1  text-gray-700 nav-menu__item hover:text-purple-500"
        >
            Usage
        </a>
    
    </li>
    </ul>
    </li>
            <li class="pl-4">
            
        <p class="nav-menu__item text-gray-500 font-extrabold text-xs tracking-widest uppercase italic pt-2">Authentication</p>
    
            
        <ul class="list-none my-0 border-l-4 border-purple-200">
            <li class="pl-4">
            
        <a href="/docs/laravel/auth/quickstart"
            class="lvl1  text-gray-700 nav-menu__item hover:text-purple-500"
        >
            Quickstart
        </a>
    
    </li>
            <li class="pl-4">
            
        <a href="/docs/laravel/auth"
            class="lvl1  text-gray-700 nav-menu__item hover:text-purple-500"
        >
            Overview
        </a>
    
    </li>
            <li class="pl-4">
            
        <a href="/docs/laravel/auth/installation"
            class="lvl1  text-gray-700 nav-menu__item hover:text-purple-500"
        >
            Installation
        </a>
    
    </li>
            <li class="pl-4">
            
        <a href="/docs/laravel/auth/configuration"
            class="lvl1  text-gray-700 nav-menu__item hover:text-purple-500"
        >
            Configuration
        </a>
    
    </li>
            <li class="pl-4">
            
        <a href="/docs/laravel/auth/setup"
            class="lvl1  text-gray-700 nav-menu__item hover:text-purple-500"
        >
            Setup
        </a>
    
    </li>
            <li class="pl-4">
            
        <a href="/docs/laravel/auth/multi-domain"
            class="lvl1  text-gray-700 nav-menu__item hover:text-purple-500"
        >
            Multi-Domain
        </a>
    
    </li>
            <li class="pl-4">
            
        <a href="/docs/laravel/auth/importing"
            class="lvl1  text-gray-700 nav-menu__item hover:text-purple-500"
        >
            Importing Users
        </a>
    
    </li>
            <li class="pl-4">
            
        <a href="/docs/laravel/auth/testing"
            class="lvl1  active font-semibold text-purple-600 nav-menu__item hover:text-purple-500"
        >
            Testing
        </a>
    
    </li>
    </ul>
    </li>
            <li class="pl-4">
            
        <p class="nav-menu__item text-gray-500 font-extrabold text-xs tracking-widest uppercase italic pt-2">Other Features</p>
    
            
        <ul class="list-none my-0 border-l-4 border-purple-200">
            <li class="pl-4">
            
        <a href="/docs/laravel/lumen"
            class="lvl1  text-gray-700 nav-menu__item hover:text-purple-500"
        >
            Lumen
        </a>
    
    </li>
            <li class="pl-4">
            
        <a href="/docs/laravel/events"
            class="lvl1  text-gray-700 nav-menu__item hover:text-purple-500"
        >
            Events
        </a>
    
    </li>
            <li class="pl-4">
            
        <a href="/docs/laravel/testing"
            class="lvl1  text-gray-700 nav-menu__item hover:text-purple-500"
        >
            Testing
        </a>
    
    </li>
            <li class="pl-4">
            
        <a href="/docs/laravel/debugging"
            class="lvl1  text-gray-700 nav-menu__item hover:text-purple-500"
        >
            Debugging
        </a>
    
    </li>
            <li class="pl-4">
            
        <a href="/docs/laravel/importing"
            class="lvl1  text-gray-700 nav-menu__item hover:text-purple-500"
        >
            Importing Objects
        </a>
    
    </li>
    </ul>
    </li>
            <li class="pl-4">
            
        <p class="nav-menu__item text-gray-500 font-extrabold text-xs tracking-widest uppercase italic pt-2">Extra</p>
    
            
        <ul class="list-none my-0 border-l-4 border-purple-200">
            <li class="pl-4">
            
        <a href="/docs/laravel/versioning"
            class="lvl1  text-gray-700 nav-menu__item hover:text-purple-500"
        >
            Versioning
        </a>
    
    </li>
            <li class="pl-4">
            
        <a href="/docs/laravel/license"
            class="lvl1  text-gray-700 nav-menu__item hover:text-purple-500"
        >
            License
        </a>
    
    </li>
    </ul>
    </li>
    </ul>

    <div class="block sm:hidden">
        <hr class="my-4"/>

        <ul class="list-none my-0">
            <li class="pl-4">
                <a href="/docs/"
                   class="nav-menu__item hover:text-blue-500"
                >
                    Core Documentation
                </a>
            </li>

            <li class="pl-4">
                <a href="https://github.com/DirectoryTree/LdapRecord-Laravel"
                   class="nav-menu__item hover:text-blue-500"
                >
                    Source Code
                </a>
            </li>
        </ul>
    </div>
            </nav>

            <div class="DocSearch-content content w-full lg:w-3/5 break-words pb-16 lg:pl-4" v-pre>
                <h1>Testing</h1>

<ul>
<li><a href="#introduction">Introduction</a></li>
<li><a href="#getting-started">Getting Started</a></li>
<li><a href="#creating-the-test">Creating the test</a></li>
<li><a href="#scopes">Scopes</a></li>
<li><a href="#rules">Rules</a></li>
</ul>

<h2 id="introduction">Introduction</h2>

<p>LdapRecord-Laravel prides itself on giving you a great and easy testing experience using
the <a href="/docs/laravel/testing#directory-emulator">Directory Emulator</a>. Using it, we can
test authentication <a href="/docs/laravel/auth/configuration#rules">rules</a>,
<a href="/docs/models#query-scopes">scopes</a> and group memberships.</p>

<h2 id="getting-started">Getting Started</h2>

<p>Before we begin, you must require the <code>doctrine/dbal</code> into your composers <code>require-dev</code> for testing.
This is due to the <code>$table-&gt;dropColumns(['guid', 'domain'])</code> call inside of the additional
LdapRecord auth migration and that we are using SQLite in our test environment.</p>

<p>This package is required for modifying columns - as described in the
<a href="https://laravel.com/docs/migrations#modifying-columns">Laravel documentation</a>.</p>

<p>To do so, run the following command:</p>

<pre><code class="language-bash">composer require doctrine/dbal --dev
</code></pre>

<h2 id="creating-the-test">Creating the test</h2>

<p>Let's whip up a test by running the following command:</p>

<pre><code class="language-bash">php artisan make:test TestLdapAuthentication
</code></pre>

<p>Inside of our generated test, we'll make use of the following traits:</p>

<p><strong>DatabaseMigrations</strong></p>

<pre><code class="language-text">Illuminate\Foundation\Testing\DatabaseMigrations
</code></pre>

<p>Using this trait will execute our migrations and ensure our database is ready to import our LDAP user.</p>

<p><strong>WithFaker</strong></p>

<pre><code class="language-text">Illuminate\Foundation\Testing\WithFaker
</code></pre>

<p>Using this trait provides us with generating fake UUID's (great for creating mock "guids"), names and emails.</p>

<p>Let's add a <code>test_auth_works</code> method into the generated test:</p>

<pre><code class="language-php">&lt;?php

namespace Tests\Feature;

use Illuminate\Foundation\Testing\DatabaseMigrations;
use Illuminate\Foundation\Testing\WithFaker;
use Illuminate\Support\Facades\Auth;
use LdapRecord\Laravel\Testing\DirectoryEmulator;
use LdapRecord\Models\ActiveDirectory\User;
use Tests\TestCase;

class TestLdapAuthentication extends TestCase
{
    use DatabaseMigrations, WithFaker;

    public function test_auth_works()
    {
        $fake = DirectoryEmulator::setup('default');

        $ldapUser = User::create([
            'cn' =&gt; $this-&gt;faker-&gt;name,
            'mail' =&gt; $this-&gt;faker-&gt;email,
            'objectguid' =&gt; $this-&gt;faker-&gt;uuid,
        ]);

        $fake-&gt;actingAs($ldapUser);

        $this-&gt;post('/login', [
            'email' =&gt; $ldapUser-&gt;mail[0],
            'password' =&gt; 'secret',
        ])-&gt;assertRedirect('/home');

        $user = Auth::user();

        $this-&gt;assertInstanceOf(\App\User::class, $user);
        $this-&gt;assertEquals($ldapUser-&gt;mail[0], $user-&gt;email);
        $this-&gt;assertEquals($ldapUser-&gt;cn[0], $ldapUser-&gt;name);
    }
}
</code></pre>

<p>Let's deconstruct what's going on here step by step.</p>

<hr />

<pre><code class="language-php">$fake = DirectoryEmulator::setup('default');
</code></pre>

<p>This first line creates a new Directory Emulator for our LDAP connection named <code>default</code> inside
of our <code>config/ldap.php</code> file. It returns a fake LDAP connection that we can use to indicate
that the user we create in this fake directory will successfully pass LDAP authentication.</p>

<hr />

<pre><code class="language-php">$user = User::create([
    'cn' =&gt; $this-&gt;faker-&gt;name,
    'mail' =&gt; $this-&gt;faker-&gt;email,
    'objectguid' =&gt; $this-&gt;faker-&gt;uuid,
]);
</code></pre>

<p>On the second line, we're creating our fake LDAP user who will be signing into our application.
You'll notice that we assign the attributes that are inside of our <code>sync_attributes</code>
specified inside of our <code>config/auth.php</code> file, as well as the users <code>objectguid</code>.</p>

<blockquote>
  <p>If you're using OpenLDAP, the <code>objectguid</code> field may be <code>entryUUID</code> or <code>uid</code>.</p>
</blockquote>

<p>This is a good place to test attribute synchronization.</p>

<hr />

<pre><code class="language-php">$fake-&gt;actingAs($user);
</code></pre>

<p>This third line, we are asserting that the user we have created will automatically pass
LDAP authentication. If we remove this line, attempting to authenticate as the
user will fail, as they are not allowed to bind using your fake connection.</p>

<hr />

<pre><code class="language-php">$this-&gt;post('/login', [
    'email' =&gt; $user-&gt;mail[0],
    'password' =&gt; 'secret',
])-&gt;assertRedirect('/home');
</code></pre>

<p>Fourth, we are sending a post request to our <code>login</code> page, with our LDAP users email address.
The password can be anything, since we asserted above (using the <code>actingAs()</code> method) that
the user <strong>will</strong> pass, regardless of what password we use.</p>

<p>If your application has <a href="/docs/laravel/auth/configuration/#database">password synchronization</a>
enabled, this is a good place to send various passwords and assert that the hashes
match after a successful login.</p>

<hr />

<pre><code class="language-php">$user = Auth::user();

$this-&gt;assertInstanceOf(\App\User::class, $user);
$this-&gt;assertEquals($ldapUser-&gt;mail[0], $user-&gt;email);
$this-&gt;assertEquals($ldapUser-&gt;cn[0], $ldapUser-&gt;name);
</code></pre>

<p>Finally, we'll check to make sure we can retrieve the successfully authenticated
user and that their attributes were successfully synchronized into our Eloquent
database model.</p>

<h2 id="scopes">Scopes</h2>

<p>To test scopes that you apply to the LdapRecord model you are using for authentication,
you will need to apply the attributes to the fake user you create to test that
they can be properly located during authentication.</p>

<p>For example, if you created a scope that enforces users to be inside of an Organizational
Unit, then we must create our fake user inside of that Organizational Unit for the
user to be located - as you would using a real LDAP directory.
Let's walk through this.</p>

<p>Below we have our scope that will enforce users to be located
inside of an Organizational Unit named <code>Administrators</code>:</p>

<pre><code class="language-php">namespace App\Ldap\Scopes;

use LdapRecord\Models\Model;
use LdapRecord\Models\Scope;
use LdapRecord\Query\Model\Builder;
use LdapRecord\Models\ActiveDirectory\OrganizationalUnit;

class AdministratorsScope implements Scope
{
    public function apply(Builder $query, Model $model)
    {
        $ou = OrganizationalUnit::where('ou', '=', 'Accounting')-&gt;first();

        $query-&gt;in($ou);
    }
}
</code></pre>

<p>And we have also added it into our model:</p>

<pre><code class="language-php">namespace App\Ldap;

use LdapRecord\Models\Model;
use App\Ldap\Scopes\AdministratorsScope;

class User extends Model
{
    protected static function boot()
    {
        parent::boot();

        static::addGlobalScope(new AdministratorsScope());
    }
}
</code></pre>

<p>Now let's create our test. To do so, we'll setup everything as we have in the above test
example, but we will create our user inside of the <code>Administrators</code> Organizational Unit:</p>

<pre><code class="language-php">public function test_auth_works()
{
    $fake = DirectoryEmulator::setup('default');

    $ou = OrganizationalUnit::create(['ou' =&gt; 'Administrators']);

    $ldapUser = (new User)-&gt;inside($ou);

    $ldapUser-&gt;save([
        'mail' =&gt; $this-&gt;faker-&gt;email,
        'cn' =&gt; $this-&gt;faker-&gt;name,
        'objectguid' =&gt; $this-&gt;faker-&gt;uuid,
    ]);

    $fake-&gt;actingAs($ldapUser);

    $this-&gt;post('/login', [
        'email' =&gt; $ldapUser-&gt;mail[0],
        'password' =&gt; 'secret',
    ])-&gt;assertRedirect('/home');

    $user = Auth::user();

    $this-&gt;assertInstanceOf(\App\User::class, $user);
    $this-&gt;assertEquals($ldapUser-&gt;mail[0], $user-&gt;email);
    $this-&gt;assertEquals($ldapUser-&gt;cn[0], $ldapUser-&gt;name);
}
</code></pre>

<p>To test the opposite of the above - such as a user who is not located inside the <code>Administrators</code>
OU, simply create them inside a different OU, or inside the root of your emulated directory:</p>

<pre><code class="language-php">public function test_auth_fails()
{
    $fake = DirectoryEmulator::setup('default');

    $ldapUser = User::create([
        'cn' =&gt; $this-&gt;faker-&gt;name,
        'mail' =&gt; $this-&gt;faker-&gt;email,
        'objectguid' =&gt; $this-&gt;faker-&gt;uuid,
    ]);

    $fake-&gt;actingAs($ldapUser);

    $this-&gt;post('/login', [
        'email' =&gt; $ldapUser-&gt;mail[0],
        'password' =&gt; 'secret',
    ])-&gt;assertSessionHasErrors('email');

    $this-&gt;assertFalse(Auth::check());
}
</code></pre>

<p>Even though we have asserted that the user passes LDAP authentication (<code>$fake-&gt;actingAs($ldapUser)</code>),
authentication will fail due to the user not being able to be located due to our scope we have
created.</p>

<p>We have also modified our redirect assertion to instead validate that the <code>email</code> session
key contains errors. This key will contain the <code>Invalid credentials</code> message.</p>

<h2 id="rules">Rules</h2>

<p>As with testing scopes, to test rules we must either apply or omit data on
our fake user to test our LDAP authentication rules.</p>

<p>An authentication rule is great for checking if a user is a member of a certain group
before allowing them to authenticate. Let's walk through an example and test this.</p>

<p>Our application requires the user to be a member of a group called <code>Help Desk</code>.
With that requirement, here is our created authentication rule:</p>

<pre><code class="language-php">&lt;?php

namespace App\Ldap\Rules;

use LdapRecord\Laravel\Auth\Rule;
use LdapRecord\Models\ActiveDirectory\Group;

class HelpDeskEmployee extends Rule
{
    public function isValid()
    {
        $group = Group::where('name', '=', 'Help Desk')-&gt;first();

        return $this-&gt;user-&gt;groups()-&gt;exists($group);
    }
}
</code></pre>

<p>This rule has also been added into our providers configuration inside our <code>config/auth.php</code> file:</p>

<pre><code class="language-php">// ...

'providers' =&gt; [
    // ...

    'ldap' =&gt; [
        // ...
        'rules' =&gt; [
            \App\Ldap\Rules\HelpDeskEmployee::class,
        ],
    ],
]
</code></pre>

<p>Now we can create our test to ensure only users who are members of the group can authenticate:</p>

<pre><code class="language-php">public function test_auth_works()
{
    $fake = DirectoryEmulator::setup('default');

    $ldapGroup = Group::create(['cn' =&gt; 'Help Desk']);

    $ldapUser = User::create([
        'cn' =&gt; $this-&gt;faker-&gt;name,
        'mail' =&gt; $this-&gt;faker-&gt;email,
        'objectguid' =&gt; $this-&gt;faker-&gt;uuid,
        'memberof' =&gt; [$ldapGroup-&gt;getDn()],
    ]);

    $ldapGroup-&gt;members()-&gt;attach($ldapUser);

    $fake-&gt;actingAs($ldapUser);

    $this-&gt;post('/login', [
        'email' =&gt; $ldapUser-&gt;mail[0],
        'password' =&gt; 'secret',
    ])-&gt;assertRedirect('/home');

    $user = Auth::user();

    $this-&gt;assertInstanceOf(\App\User::class, $user);
    $this-&gt;assertEquals($ldapUser-&gt;mail[0], $user-&gt;email);
    $this-&gt;assertEquals($ldapUser-&gt;cn[0], $ldapUser-&gt;name);
}
</code></pre>

<p>As you can see above, we created a <code>Help Desk</code> group, added the group into the users <code>memberof</code>
attribute (due to this field being virtual) and have attached them to the group.</p>

<p>Now let's create a test to ensure users who are not members of the group <strong>can't</strong> authenticate.</p>

<pre><code class="language-php">public function test_auth_fails()
{
    $fake = DirectoryEmulator::setup('default');

    $ldapUser = User::create([
        'cn' =&gt; $this-&gt;faker-&gt;name,
        'mail' =&gt; $this-&gt;faker-&gt;email,
        'objectguid' =&gt; $this-&gt;faker-&gt;uuid,
    ]);

    $fake-&gt;actingAs($ldapUser);

    $this-&gt;post('/login', [
        'email' =&gt; $ldapUser-&gt;mail[0],
        'password' =&gt; 'secret',
    ])-&gt;assertSessionHasErrors('email');

    $this-&gt;assertFalse(Auth::check());
}
</code></pre>

<p>The above test passes because we have not added our LDAP user into any groups -
so the <code>exists()</code> check inside of our rule returns <code>false</code>.</p>

                <div class="mt-12 pt-8 pb-6 border-t-2 border-purple-200">
                        <div class="flex flex-col-reverse md:flex-row justify-between items-center">
    <div class="flex flex-col items-center md:items-start">
                    <span class="font-black text-gray-500 text-sm tracking-wider uppercase pb-1">← Previous Topic</span>
            <h4 class="font-bold underline m-0 text-blue-700">
                <a href="/docs/laravel/auth/importing">Importing Users</a>
            </h4>
            </div>
    <div class="mb-8 md:mb-0 flex flex-col items-center md:items-end">
                    <span class="font-black text-gray-500 text-sm tracking-wider uppercase pb-1">Next Topic →</span>
            <h4 class="font-bold underline m-0 text-blue-700">
                <a href="/docs/laravel/lumen">Lumen</a>
            </h4>
            </div>
</div>
                </div>

                <div class="mt-8 text-center hidden md:block">
                    <a class="font-black text-gray-500 text-sm tracking-wider uppercase" href="https://github.com/DirectoryTree/LdapRecord.com/blob/master/source//docs/laravel/auth/testing.md" target="_blank">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" class="w-6 h-6 inline-block fill-current mr-1">
                            <path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"></path>
                        </svg>

                        Edit this Page
                    </a>
                </div>
            </div>
        </div>
    </section>
        </main>

        
        <script src="/assets/build/js/main.js?id=f4770a7909c663b5fd4a"></script>

        <script>
    const navMenu = {
        toggle() {
            const menu = document.getElementById('js-nav-menu');
            menu.classList.toggle('hidden');
            menu.classList.toggle('lg:block');
            document.getElementById('js-nav-menu-hide').classList.toggle('hidden');
            document.getElementById('js-nav-menu-show').classList.toggle('hidden');
        },
    }
</script>
            <script type="text/javascript">
            docsearch({
                apiKey: 'bc526397341486f980ca0b7ee7a0fa61',
                indexName: 'ldaprecord',
                inputSelector: '#docsearch-input',
                debug: false // Set debug to true if you want to inspect the dropdown
            });

            const searchInput = {
                toggle() {
                    const menu = document.getElementById('js-search-input');
                    menu.classList.toggle('hidden');
                    menu.classList.toggle('md:block');
                    document.getElementById('docsearch-input').focus();
                },
            }
        </script>
        </body>
</html>
