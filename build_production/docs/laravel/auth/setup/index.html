<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
        <meta http-equiv="x-ua-compatible" content="ie=edge">
        <meta name="description" content="LdapRecord-Laravel authentication setup guide">

        <meta property="og:site_name" content="LdapRecord"/>
        <meta property="og:title" content="Authentication Setup | LdapRecord"/>
        <meta property="og:description" content="LdapRecord-Laravel authentication setup guide"/>
        <meta property="og:url" content="https://ldaprecord.com/docs/laravel/auth/setup"/>
        <meta property="og:image" content="/assets/img/logo.png"/>
        <meta property="og:type" content="website"/>

        <meta name="twitter:image:alt" content="LdapRecord">
        <meta name="twitter:card" content="summary_large_image">

                    <meta name="generator" content="tighten_jigsaw_doc">
        
        <title>LdapRecord | Authentication Setup</title>

        <link rel="home" href="https://ldaprecord.com">
        <link rel="icon" href="/favicon.ico">
        <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
        <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
        <link rel="manifest" href="/site.webmanifest">
        <link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">
        <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
        <meta name="msapplication-TileColor" content="#da532c">
        <meta name="theme-color" content="#ffffff">

        
        <link rel="stylesheet" href="/assets/build/css/main.css?id=8919e335675314993594">

                    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/docsearch.js@2/dist/cdn/docsearch.min.css" />
            </head>
    <body class="antialiased font-sans">
        <nav class="flex items-center h-24 py-12 z-20 border-gradient-l-purple-light border-b-8 mb-2" role="banner">
            <div class="container flex items-center max-w-8xl mx-auto px-4 lg:px-8">
                <div class="flex items-center">
                    <a href="/" title="LdapRecord home" class="inline-flex items-center">
                        <img class="h-20 md:h-24 mr-3" src="/assets/img/logo.svg" alt="LdapRecord logo" />
                    </a>
                </div>

                <div class="flex flex-1 justify-end items-center text-right md:pl-10 text-gray-800">
                                            <button
    title="Start searching"
    type="button"
    class="flex md:hidden bg-gray-100 hover:bg-blue-100 justify-center items-center shadow rounded focus:outline-none h-10 px-3"
    onclick="searchInput.toggle()"
>
    <img src="/assets/img/magnifying-glass.svg" alt="search icon" class="h-4 w-4 max-w-none">
</button>

<div id="js-search-input" class="docsearch-input__wrapper hidden md:block">
    <label for="search" class="hidden">Search</label>

    <input
        id="docsearch-input"
        class="docsearch-input block h-10 transition-fast w-full lg:w-1/2 xl:w-1/3 outline-none rounded text-gray-700 focus:border-blue-400 ml-auto px-4 pb-0 shadow"
        name="docsearch"
        type="text"
        placeholder="Search"
    >

    <button
        class="md:hidden absolute right-0 mr-8 h-full font-light text-3xl text-blue-500 hover:text-blue-600 focus:outline-none -mt-px"
        onclick="searchInput.toggle()"
    >&times;</button>
</div>

                    
                                            <a href="/docs/" class="ml-6 hidden md:inline whitespace-no-wrap text-gray-800 hover:text-purple-700" title="LdapRecord Documentation Link">
                            Core Docs
                        </a>

                        <a href="https://github.com/DirectoryTree/LdapRecord-Laravel" class="hidden text-gray-800 hover:text-purple-700 sm:inline">
                            <svg class="fill-current w-8 ml-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"><title>GitHub</title><path d="M10 0a10 10 0 0 0-3.16 19.49c.5.1.68-.22.68-.48l-.01-1.7c-2.78.6-3.37-1.34-3.37-1.34-.46-1.16-1.11-1.47-1.11-1.47-.9-.62.07-.6.07-.6 1 .07 1.53 1.03 1.53 1.03.9 1.52 2.34 1.08 2.91.83.1-.65.35-1.09.63-1.34-2.22-.25-4.55-1.11-4.55-4.94 0-1.1.39-1.99 1.03-2.69a3.6 3.6 0 0 1 .1-2.64s.84-.27 2.75 1.02a9.58 9.58 0 0 1 5 0c1.91-1.3 2.75-1.02 2.75-1.02.55 1.37.2 2.4.1 2.64.64.7 1.03 1.6 1.03 2.69 0 3.84-2.34 4.68-4.57 4.93.36.31.68.92.68 1.85l-.01 2.75c0 .26.18.58.69.48A10 10 0 0 0 10 0"></path></svg>
                        </a>
                                    </div>
            </div>

                <button class="flex justify-center items-center bg-purple-500 shadow h-10 mr-4 px-5 rounded lg:hidden focus:outline-none"
    onclick="navMenu.toggle()"
>
    <svg id="js-nav-menu-show" xmlns="http://www.w3.org/2000/svg"
        class="fill-current text-white h-9 w-4" viewBox="0 0 32 32"
    >
        <path d="M4,10h24c1.104,0,2-0.896,2-2s-0.896-2-2-2H4C2.896,6,2,6.896,2,8S2.896,10,4,10z M28,14H4c-1.104,0-2,0.896-2,2  s0.896,2,2,2h24c1.104,0,2-0.896,2-2S29.104,14,28,14z M28,22H4c-1.104,0-2,0.896-2,2s0.896,2,2,2h24c1.104,0,2-0.896,2-2  S29.104,22,28,22z"/>
    </svg>

    <svg id="js-nav-menu-hide" xmlns="http://www.w3.org/2000/svg"
        class="hidden fill-current text-white h-9 w-4" viewBox="0 0 36 30"
    >
        <polygon points="32.8,4.4 28.6,0.2 18,10.8 7.4,0.2 3.2,4.4 13.8,15 3.2,25.6 7.4,29.8 18,19.2 28.6,29.8 32.8,25.6 22.2,15 "/>
    </svg>
</button>

        </nav>

        <main role="main" class="w-full">
            <div class="relative h-full max-w-screen-xl mx-auto">
                                    <svg style="left:100%;" width="404" height="784" fill="none" viewBox="0 0 404 784" class="absolute hidden sm:block transform translate-y-64 -translate-x-64">
                        <defs>
                            <pattern id="f210dbf6-a58d-4871-961e-36d5016a0f49" x="0" y="0" width="20" height="20" patternUnits="userSpaceOnUse">
                                <rect x="0" y="0" width="4" height="4" fill="currentColor" class="text-gray-200"></rect>
                            </pattern>
                        </defs>
                        <rect width="404" height="784" fill="url(#f210dbf6-a58d-4871-961e-36d5016a0f49)"></rect>
                    </svg>
                            </div>

                <section class="container relative max-w-8xl mx-auto px-6 md:px-8 py-4">
        <div class="flex flex-col lg:flex-row">
            <nav id="js-nav-menu" class="nav-menu hidden lg:block">
                    <ul class="list-none my-0 ">
            <li class="pl-4">
            
        <p class="nav-menu__item text-gray-500 font-extrabold text-xs tracking-widest uppercase italic pt-2">Introduction</p>
    
            
        <ul class="list-none my-0 border-l-4 border-purple-200">
            <li class="pl-4">
            
        <a href="/docs/laravel/quickstart"
            class="lvl1  text-gray-700 nav-menu__item hover:text-purple-500"
        >
            Quickstart
        </a>
    
    </li>
            <li class="pl-4">
            
        <a href="/docs/laravel"
            class="lvl1  text-gray-700 nav-menu__item hover:text-purple-500"
        >
            Overview
        </a>
    
    </li>
            <li class="pl-4">
            
        <a href="/docs/laravel/installation"
            class="lvl1  text-gray-700 nav-menu__item hover:text-purple-500"
        >
            Installation
        </a>
    
    </li>
            <li class="pl-4">
            
        <a href="/docs/laravel/usage"
            class="lvl1  text-gray-700 nav-menu__item hover:text-purple-500"
        >
            Usage
        </a>
    
    </li>
    </ul>
    </li>
            <li class="pl-4">
            
        <p class="nav-menu__item text-gray-500 font-extrabold text-xs tracking-widest uppercase italic pt-2">Authentication</p>
    
            
        <ul class="list-none my-0 border-l-4 border-purple-200">
            <li class="pl-4">
            
        <a href="/docs/laravel/auth/quickstart"
            class="lvl1  text-gray-700 nav-menu__item hover:text-purple-500"
        >
            Quickstart
        </a>
    
    </li>
            <li class="pl-4">
            
        <a href="/docs/laravel/auth"
            class="lvl1  text-gray-700 nav-menu__item hover:text-purple-500"
        >
            Overview
        </a>
    
    </li>
            <li class="pl-4">
            
        <a href="/docs/laravel/auth/installation"
            class="lvl1  text-gray-700 nav-menu__item hover:text-purple-500"
        >
            Installation
        </a>
    
    </li>
            <li class="pl-4">
            
        <a href="/docs/laravel/auth/configuration"
            class="lvl1  text-gray-700 nav-menu__item hover:text-purple-500"
        >
            Configuration
        </a>
    
    </li>
            <li class="pl-4">
            
        <a href="/docs/laravel/auth/setup"
            class="lvl1  active font-semibold text-purple-600 nav-menu__item hover:text-purple-500"
        >
            Setup
        </a>
    
    </li>
            <li class="pl-4">
            
        <a href="/docs/laravel/auth/multi-domain"
            class="lvl1  text-gray-700 nav-menu__item hover:text-purple-500"
        >
            Multi-Domain
        </a>
    
    </li>
            <li class="pl-4">
            
        <a href="/docs/laravel/auth/importing"
            class="lvl1  text-gray-700 nav-menu__item hover:text-purple-500"
        >
            Importing Users
        </a>
    
    </li>
            <li class="pl-4">
            
        <a href="/docs/laravel/auth/testing"
            class="lvl1  text-gray-700 nav-menu__item hover:text-purple-500"
        >
            Testing
        </a>
    
    </li>
    </ul>
    </li>
            <li class="pl-4">
            
        <p class="nav-menu__item text-gray-500 font-extrabold text-xs tracking-widest uppercase italic pt-2">Other Features</p>
    
            
        <ul class="list-none my-0 border-l-4 border-purple-200">
            <li class="pl-4">
            
        <a href="/docs/laravel/importing"
            class="lvl1  text-gray-700 nav-menu__item hover:text-purple-500"
        >
            Importing Objects
        </a>
    
    </li>
            <li class="pl-4">
            
        <a href="/docs/laravel/events"
            class="lvl1  text-gray-700 nav-menu__item hover:text-purple-500"
        >
            Events
        </a>
    
    </li>
            <li class="pl-4">
            
        <a href="/docs/laravel/testing"
            class="lvl1  text-gray-700 nav-menu__item hover:text-purple-500"
        >
            Testing
        </a>
    
    </li>
            <li class="pl-4">
            
        <a href="/docs/laravel/debugging"
            class="lvl1  text-gray-700 nav-menu__item hover:text-purple-500"
        >
            Debugging
        </a>
    
    </li>
    </ul>
    </li>
            <li class="pl-4">
            
        <p class="nav-menu__item text-gray-500 font-extrabold text-xs tracking-widest uppercase italic pt-2">Extra</p>
    
            
        <ul class="list-none my-0 border-l-4 border-purple-200">
            <li class="pl-4">
            
        <a href="/docs/laravel/versioning"
            class="lvl1  text-gray-700 nav-menu__item hover:text-purple-500"
        >
            Versioning
        </a>
    
    </li>
            <li class="pl-4">
            
        <a href="/docs/laravel/license"
            class="lvl1  text-gray-700 nav-menu__item hover:text-purple-500"
        >
            License
        </a>
    
    </li>
    </ul>
    </li>
    </ul>

    <div class="block sm:hidden">
        <hr class="my-4"/>

        <ul class="list-none my-0">
            <li class="pl-4">
                <a href="/docs/"
                   class="nav-menu__item hover:text-blue-500"
                >
                    Core Documentation
                </a>
            </li>

            <li class="pl-4">
                <a href="https://github.com/DirectoryTree/LdapRecord-Laravel"
                   class="nav-menu__item hover:text-blue-500"
                >
                    Source Code
                </a>
            </li>
        </ul>
    </div>
            </nav>

            <div class="DocSearch-content content w-full lg:w-3/5 break-words pb-16 lg:pl-4" v-pre>
                <h1>Setup</h1>

<ul>
<li><a href="#guard">Authentication Guard</a></li>
<li><a href="#login-controller">Login Controller</a></li>
<li><a href="#using-usernames">Using Usernames</a></li>
<li><a href="#model-binding">Eloquent Model Binding</a></li>
<li><a href="#passthrough-authentication">Pass-Through Authentication / SSO</a>

<ul>
<li><a href="#sso-domain-verification">Domain Verification</a></li>
<li><a href="#changing-the-sso-server-key">Changing the Server Key</a></li>
<li><a href="#selective-sigle-sign-on">Selective / Bypassing Single-Sign-On</a></li>
</ul></li>
<li><a href="#displaying-ldap-error-messages">Displaying LDAP Error Messages (password expiry, account lockouts)</a></li>
</ul>

<h2 id="guard">Authentication Guard</h2>

<p>Once you have <a href="/docs/laravel/auth/configuration">configured a new authentication provider</a>,
you will have to setup your authentication guard to use this new provider.</p>

<p>For this example, we will change our default <code>web</code> guard to use our new <code>ldap</code> provider:</p>

<pre><code class="language-php">// config/auth.php

'guards' =&gt; [
    'web' =&gt; [
        'driver' =&gt; 'session',
        'provider' =&gt; 'ldap', // Changed from 'users'
    ],

    // ...
],
</code></pre>

<h2 id="login-controller">Login Controller</h2>

<p>Now that we have updated our default authentication guard to use our new <code>ldap</code> provider, we will jump into
the default <code>LoginController</code> that is included with the <a href="https://laravel.com/docs/authentication#introduction">Laravel UI package</a>.</p>

<p>For this example application, we will authenticate our LDAP users with their email address using the LDAP attribute <code>mail</code>.</p>

<p>To have LdapRecord properly locate the user in your directory during login,
we will override the <code>credentials</code> method in the <code>LoginController</code>:</p>

<pre><code class="language-php">// app/Http/Controllers/Auth/LoginController.php

use Illuminate\Http\Request;

protected function credentials(Request $request)
{
    return [
        'mail' =&gt; $request-&gt;email,
        'password' =&gt; $request-&gt;password,
    ];
}
</code></pre>

<p>As you can see above, we set the <code>mail</code> key which is passed to the LdapRecord authentication provider.</p>

<p>A search query will be executed on your directory for a user that contains the <code>mail</code> attribute equal
to the entered <code>email</code> that the user has submitted on your login form. The <code>password</code>
key will not be used in the search.</p>

<p>If a user is not found in your directory, or they fail authentication, they will be redirected to the
login page normally with the "Invalid credentials" error message.</p>

<blockquote>
  <p>You may also add extra key => value pairs in the <code>credentials</code> array to further scope the
  LDAP query. The <code>password</code> key is automatically ignored by LdapRecord.</p>
</blockquote>

<h2 id="using-usernames">Using Usernames</h2>

<p>In corporate environments, users are often used to signing into their computers with their username.
You can certainly keep this flow easy for them - we just need to change a couple things.</p>

<p>First, you will need to change the <code>email</code> column in the database migration that creates your <code>users</code>
table to <code>username</code>, as this represents what it will now contain:</p>

<pre><code class="language-php">Schema::create('users', function (Blueprint $table) {
    // ...

    // Before...
    $table-&gt;string('email')-&gt;unique(); 

    // After...
    $table-&gt;string('username')-&gt;unique(); 
});
</code></pre>

<blockquote>
  <p>Make sure you run your migrations using <code>php artisan migrate</code>.</p>
</blockquote>

<p>Once we've changed the name of the column, we'll jump into the <code>config/auth.php</code> configuration and modify 
our LDAP user providers <code>sync_attributes</code> to synchronize this changed column.</p>

<p>In this example, we will use the users <code>sAMAccountName</code> as their username
which is common in Active Directory environments:</p>

<pre><code class="language-php">// config/auth.php

'providers' =&gt; [
    // ...

    'ldap' =&gt; [
        // ...

        'database' =&gt; [
            // ...

            'sync_attributes' =&gt; [
                'name' =&gt; 'cn',
                'username' =&gt; 'samaccountname',
            ],
        ],
    ],
],
</code></pre>

<p>Now, since we have changed the way our users sign into our application from the default <code>email</code> field,
we need to modify our HTML login form to reflect this. Let's jump into our <code>auth/login.blade.php</code>:</p>

<pre><code class="language-html">&lt;!-- resources/views/auth/login.blade.php --&gt;

&lt;!-- Before... --&gt;
&lt;input id="email" type="email" class="form-control @error('email') is-invalid @enderror" name="email" value="{{ old('email') }}" required autocomplete="email" autofocus&gt;

&lt;!-- After... --&gt;
&lt;input id="username" type="text" class="form-control @error('username') is-invalid @enderror" name="username" value="{{ old('username') }}" required autocomplete="username" autofocus&gt;
</code></pre>

<p>After changing the HTML input, we now must modify our <code>LoginController</code> to use this new field.
We do this by overriding the <code>username</code> method, and updating our <code>credentials</code> method:</p>

<pre><code class="language-php">// app/Http/Controllers/Auth/LoginController.php

use Illuminate\Http\Request;

public function username()
{
    return 'username';
}

protected function credentials(Request $request)
{
    return [
        'samaccountname' =&gt; $request-&gt;get('username'),
        'password' =&gt; $request-&gt;get('password'),
    ];
}
</code></pre>

<p>You can now sign into your application using usernames instead of email addresses.</p>

<h2 id="model-binding">Eloquent Model Binding</h2>

<p>If you are using <a href="/docs/laravel/auth#database">database synchronization</a>, model binding allows
you to attach the users LdapRecord model to their Eloquent model so their LDAP data is
available on every request automatically.</p>

<blockquote>
  <p>Using this feature will perform a single query on your LDAP server for a <strong>logged in user per request</strong>.
  This could lead to slightly longer load times depending on your LDAP server and network speed.
  <br/><br/>
  This also means <strong>persistent LDAP connectivity is required</strong> while LDAP
  authenticated users use your Laravel application.</p>
</blockquote>

<p>To begin, insert the <code>LdapRecord\Laravel\Auth\HasLdapUser</code> trait onto your User model:</p>

<pre><code class="language-php">namespace App;

use LdapRecord\Laravel\Auth\HasLdapUser;
use Illuminate\Foundation\Auth\User as Authenticatable;

class User extends Authenticatable
{
    use HasLdapUser;
</code></pre>

<p>Now, after an LDAP user logs into your application, their LdapRecord model will be available on
their model via the <code>ldap</code> property:</p>

<pre><code class="language-php">// Instance of App\User
$user = Auth::user();

// Instance of App\Ldap\User
$user-&gt;ldap;

// Get LDAP user attributes
echo $user-&gt;ldap-&gt;getFirstAttribute('cn');

// Get LDAP user relationships:
$groups = $user-&gt;ldap-&gt;groups()-&gt;get();
</code></pre>

<h2 id="passthrough-authentication">Pass-through Authentication / SSO</h2>

<p>Pass-through authentication allows your users to be automatically signed in when they access your
application on a Windows domain joined computer. This feature is ideal for in-house corporate
environments.</p>

<p>However, this feature assumes that you have enabled Windows Authentication in IIS, or have enabled
it in some other means with Apache. LdapRecord does not set this up for you. To enable Windows
Authentication, visit the <a href="https://www.iis.net/configreference/system.webserver/security/authentication/windowsauthentication/providers/add">IIS configuration guide</a>.</p>

<p>When you have it enabled on your server and a user visits your application from a domain joined computer,
the users <code>sAMAccountName</code> becomes available on a PHP server variable (<code>$_SERVER['AUTH_USER']</code>).</p>

<p>LdapRecord provides a middleware that you apply to your stack which retrieves this username
from the request, attempts to locate the user in your directory, then logs the user in.</p>

<p>To use the middleware, insert it on your middleware stack inside your <code>app/Http/Kernel.php</code> file:</p>

<pre><code class="language-php">protected $middlewareGroups = [
    'web' =&gt; [
        // ...
        \LdapRecord\Laravel\Middleware\WindowsAuthenticate::class,
    ],
];
</code></pre>

<blockquote>
  <p>The <code>WindowsAuthenticate</code> middleware uses the rules you have configured inside your <code>config/auth.php</code> file.
  A user may successfully authenticate against your LDAP server when visiting your site, but depending
  on your rules, may not be imported or logged in.</p>
</blockquote>

<h3 id="sso-domain-verification">SSO Domain Verification</h3>

<p>To prevent security issues using multiple-domain authentication using the <code>WindowsAuthenticate</code> middleware,
domain verification is performed on the authenticating user by checking if their domain name is contained
inside of the users distinguished name that is retrieved from each of your configured LDAP guards.</p>

<blockquote>
  <p>Only 'Domain Components' are checked in the users distinguished name. More on this below.</p>
</blockquote>

<p>To describe this issue in further detail -- the <code>WindowsAuthenticate</code> middleware retrieves all of your configured
authentication guards inside of your <code>config/auth.php</code> file, determines which one is using the <code>ldap</code>
driver, and then attempts to locate the authenticating users from <strong>each connection</strong>.</p>

<p>Since there is the possibility of users having the same <code>sAMAccountName</code> on two separate domains,
LdapRecord must verify that the user retrieved from your domain is in-fact the user who
is connecting to your Laravel application via Single-Sign-On.</p>

<p>For example, if a user visits your Laravel application with the username of:</p>

<pre><code class="language-text">ACME\sbauman
</code></pre>

<p>And LdapRecord locates a user with the distinguished name of:</p>

<pre><code class="language-text">cn=sbauman,ou=users,dc=local,dc=com
</code></pre>

<p>They will be denied authentication. This is because the authenticating user has a domain of
<code>ACME</code>, but it is not contained inside of their distinguished name domain components (dc).</p>

<p>Using the same example, if the located users distinguished name is:</p>

<pre><code class="language-text">cn=sbauman,ou=users,dc=acme,dc=com
</code></pre>

<p>Then they will be allowed to authenticate, as their <code>ACME</code> domain is contained inside of
their distinguished name domain components (<code>dc=acme</code>).</p>

<blockquote>
  <p>Comparison against each domain component is done in a <strong>case-insensitive</strong> manor.</p>
</blockquote>

<p>If you would like to disable this check, you must call the static method <code>bypassDomainVerification</code>
on the <code>WindowsAuthenticate</code> middleware inside of your <code>AuthServiceProvider</code>:</p>

<blockquote>
  <p><strong>Important</strong>: If you only connect to one domain inside your application,
  this is not a security issue. However, if you use multi-domain authentication
  and disable this check, users who have the same <code>sAMAccountName</code> could login as eachother. <strong>This is a security issue. You have been warned.</strong></p>
</blockquote>

<pre><code class="language-php">// app/Providers/AuthServiceProvider.php

/**
 * Register any authentication / authorization services.
 *
 * @return void
 */
public function boot()
{
    $this-&gt;registerPolicies();

    WindowsAuthenticate::bypassDomainVerification();
}
</code></pre>

<h3 id="changing-the-sso-server-key">Changing the Server Key</h3>

<p>By default, the <code>WindowsAuthenticate</code> middleware uses the <code>AUTH_USER</code> key inside of PHP's <code>$_SERVER</code>
array (<code>$_SERVER['AUTH_USER']</code>). If you would like to change this, call the <code>serverKey</code> method on
the <code>WindowsAuthenticate</code> middleware inside of your <code>AuthServiceProvider</code>:</p>

<pre><code class="language-php">// app/Providers/AuthServiceProvider.php

/**
 * Register any authentication / authorization services.
 *
 * @return void
 */
public function boot()
{
    $this-&gt;registerPolicies();

    WindowsAuthenticate::serverKey('PHP_AUTH_USER');
}
</code></pre>

<h3 id="selective-sigle-sign-on">Selective / Bypassing Single-Sign-On</h3>

<p>Occasionally you may need to allow users who are not apart of the domain
to login  to your application, as well as allowing domain users to
automatically sign in via Single-Sign-On.</p>

<p>Unfortunately, NTLM / Windows authentication is all-or-nothing on your entire web application. This means,
you cannot enable a single HTTP endpoint in your application to use Single-Sign-On or exempt a portion
of your application. However, there is a workaround that is used frequently in the industry.</p>

<p>The goal is to have two URL's that point to the same Laravel application. One that
has Windows authentication enabled, and another that does not. This is typically idendified by an <code>sso</code> sub-domain:</p>

<pre><code class="language-html">&lt;!-- Standard URL --&gt;
my-app.com

&lt;!-- Single-Sign-On URL --&gt;
sso.my-app.com
</code></pre>

<p>To do this, you must create a new IIS instance and point to the same Laravel application. Then, you simply 
have Windows authentication enabled on one instance, and left disabled on another.</p>

<p>Nothing needs to be done in your Laravel application. The <code>WindowsAuthenticate</code> middleware
will only attempt to authenticate users when the <code>AUTH_USER</code> server key is present,
so it can remain in the global middleware stack.</p>

<h2 id="displaying-ldap-error-messages">Displaying LDAP Error Messages</h2>

<p>When a user fails LDAP authentication due to their password / account expiring, account
lockout or their password requiring to be changed, specific error codes are sent
back from your server. LdapRecord can interpret these for you and display
helpful error messages to users upon failing authentication.</p>

<p>To add this functionality, you must add the following trait to your <code>LoginController</code>:</p>

<pre><code class="language-text">LdapRecord\Laravel\Auth\ListensForLdapBindFailure
</code></pre>

<p>Example:</p>

<pre><code class="language-php">// app/Http/Controllers/Auth/LoginController.php

// ...

use LdapRecord\Laravel\Auth\ListensForLdapBindFailure;

class LoginController extends Controller
{
    use AuthenticatesUsers, ListensForLdapBindFailure;

    // ...
</code></pre>

<p><strong>However, this feature will only work automatically if your <code>LoginController</code> resides in the default
<code>App\Http\Controllers\Auth</code> namespace</strong>. If you have changed the location of your <code>LoginController</code>,
you must modify the constructor and add the following method call to register the LDAP listener:</p>

<pre><code class="language-php">// app/Http/Controllers/Auth/LoginController.php

// ...

use LdapRecord\Laravel\Auth\ListensForLdapBindFailure;

class LoginController extends Controller
{
    use AuthenticatesUsers, ListensForLdapBindFailure;

    public function __construct()
    {
        $this-&gt;middleware('guest')-&gt;except('logout');

        $this-&gt;listenForLdapBindFailure();
    }
</code></pre>

<h3>Altering the response</h3>

<p>By default, when an LDAP bind failure occurs, a <code>ValidationException</code> will be thrown which will
redirect users to your login page and display the error. If you would like to modify this
behaviour, you will need to override the method <code>handleLdapBindError</code>.</p>

<p>This method will include the error message as the first parameter and the error code as the second.</p>

<p>This is useful for checking for specific Active Directory response codes and returning a response:</p>

<pre><code class="language-php">// app/Http/Controllers/Auth/LoginController.php

// ...

class LoginController extends Controller
{
    // ...

    use ListensForLdapBindFailure {
        handleLdapBindError as baseHandleLdapBindError;
    }

    protected function handleLdapBindError($message, $code = null)
    {
        if ($code == '773') {
            // The users password has expired. Redirect them.
            abort(redirect('/password-reset'));
        }

        $this-&gt;baseHandleLdapBindError($message, $code);
    }
}
</code></pre>

<blockquote>
  <p>Refer to the <a href="/docs/active-directory/users/#password-policy-errors">Password Policy Errors</a>
  documentation to see what each code means.</p>
</blockquote>

                <div class="mt-12 pt-8 pb-6 border-t-2 border-purple-200">
                        <div class="flex flex-col-reverse md:flex-row justify-between items-center">
    <div class="flex flex-col items-center md:items-start">
                    <span class="font-black text-gray-500 text-sm tracking-wider uppercase pb-1">← Previous Topic</span>
            <h4 class="font-bold underline m-0 text-blue-700">
                <a href="/docs/laravel/auth/configuration">Configuration</a>
            </h4>
            </div>
    <div class="mb-8 md:mb-0 flex flex-col items-center md:items-end">
                    <span class="font-black text-gray-500 text-sm tracking-wider uppercase pb-1">Next Topic →</span>
            <h4 class="font-bold underline m-0 text-blue-700">
                <a href="/docs/laravel/auth/multi-domain">Multi-Domain</a>
            </h4>
            </div>
</div>
                </div>

                <div class="mt-8 text-center hidden md:block">
                    <a class="font-black text-gray-500 text-sm tracking-wider uppercase" href="https://github.com/DirectoryTree/LdapRecord.com/blob/master/source//docs/laravel/auth/setup.md" target="_blank">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" class="w-6 h-6 inline-block fill-current mr-1">
                            <path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"></path>
                        </svg>

                        Edit this Page
                    </a>
                </div>
            </div>
        </div>
    </section>
        </main>

        
        <script src="/assets/build/js/main.js?id=f4770a7909c663b5fd4a"></script>

        <script>
    const navMenu = {
        toggle() {
            const menu = document.getElementById('js-nav-menu');
            menu.classList.toggle('hidden');
            menu.classList.toggle('lg:block');
            document.getElementById('js-nav-menu-hide').classList.toggle('hidden');
            document.getElementById('js-nav-menu-show').classList.toggle('hidden');
        },
    }
</script>
            <script type="text/javascript">
            docsearch({
                apiKey: 'bc526397341486f980ca0b7ee7a0fa61',
                indexName: 'ldaprecord',
                inputSelector: '#docsearch-input',
                debug: false // Set debug to true if you want to inspect the dropdown
            });

            const searchInput = {
                toggle() {
                    const menu = document.getElementById('js-search-input');
                    menu.classList.toggle('hidden');
                    menu.classList.toggle('md:block');
                    document.getElementById('docsearch-input').focus();
                },
            }
        </script>
        </body>
</html>
