<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
        <meta http-equiv="x-ua-compatible" content="ie=edge">
        <meta name="description" content="LdapRecord-Laravel testing guide">

        <meta property="og:site_name" content="LdapRecord"/>
        <meta property="og:title" content="Testing with LdapRecord | LdapRecord"/>
        <meta property="og:description" content="LdapRecord-Laravel testing guide"/>
        <meta property="og:url" content="https://ldaprecord.com/docs/laravel/testing"/>
        <meta property="og:image" content="/assets/img/logo.png"/>
        <meta property="og:type" content="website"/>

        <meta name="twitter:image:alt" content="LdapRecord">
        <meta name="twitter:card" content="summary_large_image">

                    <meta name="generator" content="tighten_jigsaw_doc">
        
        <title>LdapRecord | Testing with LdapRecord</title>

        <link rel="home" href="https://ldaprecord.com">
        <link rel="icon" href="/favicon.ico">
        <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
        <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
        <link rel="manifest" href="/site.webmanifest">
        <link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">
        <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
        <meta name="msapplication-TileColor" content="#da532c">
        <meta name="theme-color" content="#ffffff">

        
        <link rel="stylesheet" href="/assets/build/css/main.css?id=b695d4560772c4cab0ef">

                    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/docsearch.js@2/dist/cdn/docsearch.min.css" />
            </head>
    <body class="flex flex-col bg-gray-100 font-sans">
        <header class="flex items-center h-24 py-12 z-20 relative border-t-8 border-purple-600 bg-white shadow mb-2" role="banner">
            <div class="container flex items-center max-w-8xl mx-auto px-4 lg:px-8">
                <div class="flex items-center">
                    <a href="/" title="LdapRecord home" class="inline-flex items-center">
                        <img class="h-20 md:h-24 mr-3" src="/assets/img/logo.svg" alt="LdapRecord logo" />
                    </a>
                </div>

                <div class="flex flex-1 justify-end items-center text-right md:pl-10 text-blue-800">
                                            <button
    title="Start searching"
    type="button"
    class="flex md:hidden bg-gray-100 hover:bg-blue-100 justify-center items-center border border-gray-500 rounded-full focus:outline-none h-10 px-3"
    onclick="searchInput.toggle()"
>
    <img src="/assets/img/magnifying-glass.svg" alt="search icon" class="h-4 w-4 max-w-none">
</button>

<div id="js-search-input" class="docsearch-input__wrapper hidden md:block">
    <label for="search" class="hidden">Search</label>

    <input
        id="docsearch-input"
        class="docsearch-input relative block h-10 transition-fast w-full lg:w-1/2 xl:w-1/3 bg-gray-100 outline-none rounded-full text-gray-700 border border-gray-500 focus:border-blue-400 ml-auto px-4 pb-0"
        name="docsearch"
        type="text"
        placeholder="Search"
    >

    <button
        class="md:hidden absolute right-0 mr-8 h-full font-light text-3xl text-blue-500 hover:text-blue-600 focus:outline-none -mt-px"
        onclick="searchInput.toggle()"
    >&times;</button>
</div>

                    
                                            <a href="/docs/" class="ml-6 hidden md:inline whitespace-no-wrap text-blue-800" title="LdapRecord Documentation Link">
                            Core Docs
                        </a>

                        <a href="https://github.com/DirectoryTree/LdapRecord-Laravel" class="hidden hover:text-purple-900 sm:inline text-blue-800">
                            <svg class="fill-current w-8 ml-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"><title>GitHub</title><path d="M10 0a10 10 0 0 0-3.16 19.49c.5.1.68-.22.68-.48l-.01-1.7c-2.78.6-3.37-1.34-3.37-1.34-.46-1.16-1.11-1.47-1.11-1.47-.9-.62.07-.6.07-.6 1 .07 1.53 1.03 1.53 1.03.9 1.52 2.34 1.08 2.91.83.1-.65.35-1.09.63-1.34-2.22-.25-4.55-1.11-4.55-4.94 0-1.1.39-1.99 1.03-2.69a3.6 3.6 0 0 1 .1-2.64s.84-.27 2.75 1.02a9.58 9.58 0 0 1 5 0c1.91-1.3 2.75-1.02 2.75-1.02.55 1.37.2 2.4.1 2.64.64.7 1.03 1.6 1.03 2.69 0 3.84-2.34 4.68-4.57 4.93.36.31.68.92.68 1.85l-.01 2.75c0 .26.18.58.69.48A10 10 0 0 0 10 0"></path></svg>
                        </a>
                                    </div>
            </div>

                <button class="flex justify-center items-center bg-purple-500 border border-purple-500 h-10 mr-4 px-5 rounded-full lg:hidden focus:outline-none"
    onclick="navMenu.toggle()"
>
    <svg id="js-nav-menu-show" xmlns="http://www.w3.org/2000/svg"
        class="fill-current text-white h-9 w-4" viewBox="0 0 32 32"
    >
        <path d="M4,10h24c1.104,0,2-0.896,2-2s-0.896-2-2-2H4C2.896,6,2,6.896,2,8S2.896,10,4,10z M28,14H4c-1.104,0-2,0.896-2,2  s0.896,2,2,2h24c1.104,0,2-0.896,2-2S29.104,14,28,14z M28,22H4c-1.104,0-2,0.896-2,2s0.896,2,2,2h24c1.104,0,2-0.896,2-2  S29.104,22,28,22z"/>
    </svg>

    <svg id="js-nav-menu-hide" xmlns="http://www.w3.org/2000/svg"
        class="hidden fill-current text-white h-9 w-4" viewBox="0 0 36 30"
    >
        <polygon points="32.8,4.4 28.6,0.2 18,10.8 7.4,0.2 3.2,4.4 13.8,15 3.2,25.6 7.4,29.8 18,19.2 28.6,29.8 32.8,25.6 22.2,15 "/>
    </svg>
</button>

        </header>

        <main role="main" class="w-full">
                <section class="container max-w-8xl mx-auto px-6 md:px-8 py-4">
        <div class="flex flex-col lg:flex-row">
            <nav id="js-nav-menu" class="nav-menu hidden lg:block">
                    <ul class="list-none my-0 ">
            <li class="pl-4">
            
        <p class="nav-menu__item text-gray-500 font-extrabold text-xs tracking-widest uppercase italic pt-2">Introduction</p>
    
            
        <ul class="list-none my-0 border-l-4 border-purple-200">
            <li class="pl-4">
            
        <a href="/docs/laravel/quickstart"
            class="lvl1  text-gray-700 nav-menu__item hover:text-purple-500"
        >
            Quickstart
        </a>
    
    </li>
            <li class="pl-4">
            
        <a href="/docs/laravel"
            class="lvl1  text-gray-700 nav-menu__item hover:text-purple-500"
        >
            Overview
        </a>
    
    </li>
            <li class="pl-4">
            
        <a href="/docs/laravel/installation"
            class="lvl1  text-gray-700 nav-menu__item hover:text-purple-500"
        >
            Installation
        </a>
    
    </li>
            <li class="pl-4">
            
        <a href="/docs/laravel/usage"
            class="lvl1  text-gray-700 nav-menu__item hover:text-purple-500"
        >
            Usage
        </a>
    
    </li>
    </ul>
    </li>
            <li class="pl-4">
            
        <p class="nav-menu__item text-gray-500 font-extrabold text-xs tracking-widest uppercase italic pt-2">Authentication</p>
    
            
        <ul class="list-none my-0 border-l-4 border-purple-200">
            <li class="pl-4">
            
        <a href="/docs/laravel/auth/quickstart"
            class="lvl1  text-gray-700 nav-menu__item hover:text-purple-500"
        >
            Quickstart
        </a>
    
    </li>
            <li class="pl-4">
            
        <a href="/docs/laravel/auth"
            class="lvl1  text-gray-700 nav-menu__item hover:text-purple-500"
        >
            Overview
        </a>
    
    </li>
            <li class="pl-4">
            
        <a href="/docs/laravel/auth/installation"
            class="lvl1  text-gray-700 nav-menu__item hover:text-purple-500"
        >
            Installation
        </a>
    
    </li>
            <li class="pl-4">
            
        <a href="/docs/laravel/auth/configuration"
            class="lvl1  text-gray-700 nav-menu__item hover:text-purple-500"
        >
            Configuration
        </a>
    
    </li>
            <li class="pl-4">
            
        <a href="/docs/laravel/auth/usage"
            class="lvl1  text-gray-700 nav-menu__item hover:text-purple-500"
        >
            Usage
        </a>
    
    </li>
            <li class="pl-4">
            
        <a href="/docs/laravel/auth/multi-domain"
            class="lvl1  text-gray-700 nav-menu__item hover:text-purple-500"
        >
            Multi-Domain
        </a>
    
    </li>
            <li class="pl-4">
            
        <a href="/docs/laravel/auth/importing"
            class="lvl1  text-gray-700 nav-menu__item hover:text-purple-500"
        >
            Importing Users
        </a>
    
    </li>
            <li class="pl-4">
            
        <a href="/docs/laravel/auth/testing"
            class="lvl1  text-gray-700 nav-menu__item hover:text-purple-500"
        >
            Testing
        </a>
    
    </li>
    </ul>
    </li>
            <li class="pl-4">
            
        <p class="nav-menu__item text-gray-500 font-extrabold text-xs tracking-widest uppercase italic pt-2">Other Features</p>
    
            
        <ul class="list-none my-0 border-l-4 border-purple-200">
            <li class="pl-4">
            
        <a href="/docs/laravel/importing"
            class="lvl1  text-gray-700 nav-menu__item hover:text-purple-500"
        >
            Importing Objects
        </a>
    
    </li>
            <li class="pl-4">
            
        <a href="/docs/laravel/testing"
            class="lvl1  active font-semibold text-purple-600 nav-menu__item hover:text-purple-500"
        >
            Testing
        </a>
    
    </li>
            <li class="pl-4">
            
        <a href="/docs/laravel/debugging"
            class="lvl1  text-gray-700 nav-menu__item hover:text-purple-500"
        >
            Debugging
        </a>
    
    </li>
    </ul>
    </li>
            <li class="pl-4">
            
        <p class="nav-menu__item text-gray-500 font-extrabold text-xs tracking-widest uppercase italic pt-2">Extra</p>
    
            
        <ul class="list-none my-0 border-l-4 border-purple-200">
            <li class="pl-4">
            
        <a href="/docs/laravel/versioning"
            class="lvl1  text-gray-700 nav-menu__item hover:text-purple-500"
        >
            Versioning
        </a>
    
    </li>
            <li class="pl-4">
            
        <a href="/docs/laravel/license"
            class="lvl1  text-gray-700 nav-menu__item hover:text-purple-500"
        >
            License
        </a>
    
    </li>
    </ul>
    </li>
    </ul>

    <div class="block sm:hidden">
        <hr class="my-4"/>

        <ul class="list-none my-0">
            <li class="pl-4">
                <a href="/docs/"
                   class="nav-menu__item hover:text-blue-500"
                >
                    Core Documentation
                </a>
            </li>

            <li class="pl-4">
                <a href="https://github.com/DirectoryTree/LdapRecord-Laravel"
                   class="nav-menu__item hover:text-blue-500"
                >
                    Source Code
                </a>
            </li>
        </ul>
    </div>
            </nav>

            <div class="DocSearch-content content w-full lg:w-3/5 break-words pb-16 lg:pl-4" v-pre>
                <h1>Testing</h1>

<ul>
<li><a href="#introduction">Introduction</a></li>
<li><a href="#directory-emulator">Directory Emulator</a></li>
<li><a href="#getting-started">Getting Started</a></li>
<li><a href="#sqlite-file-database">Using a SQLite File Database</a></li>
<li><a href="#emulated-queries">Emulated Queries</a></li>
<li><a href="#working-with-relationships">Working with Relationships</a></li>
</ul>

<h2 id="introduction">Introduction</h2>

<p>Testing LDAP integration for PHP has always been quite difficult. Any type of integration
that is needed, you either need a real LDAP server to test against, or you mock
every response given and assume the logic you have in place will work until
you do live testing with a real LDAP server. This is finicky and hard to
test in an easy way.</p>

<p>That's where the LdapRecord <strong>Directory Emulator</strong> comes in.</p>

<h2 id="directory-emulator">Directory Emulator</h2>

<p>The Directory Emulator dynamically replaces the LDAP connection you specify with a fake
one. This fake connection sets up an SQLite database that resembles an LDAP directory
and allows you to store, update, delete, move, rename, and query LDAP objects through LdapRecord.</p>

<p>The SQLite database can be stored as file so you can utilize it in your application,
or you can use an in-memory database for running unit tests. It's the perfect
suite for testing the LDAP integration in your Laravel applications.</p>

<p>When you query a model that uses the connection you have setup with the Directory Emulator,
LdapRecord dynamically swaps query filters with Eloquent SQL queries, effectively
allowing you to query objects you create inside of your emulated directory.</p>

<h2 id="getting-started">Getting Started</h2>

<p>To begin, let's say we have an application that lists LDAP users inside of your configured directory.</p>

<p>Inside of our <code>config/ldap.php</code> file, we have defined our single <code>default</code> connection:</p>

<pre><code class="language-php">// config/ldap.php

'default' =&gt; env('LDAP_CONNECTION', 'default'),

'connections' =&gt; [
    'default' =&gt; [
        // ...
        'base_dn' =&gt; 'dc=local,dc=com',
    ],
],
</code></pre>

<p>We have a <code>UsersController</code> that displays the LDAP users:</p>

<pre><code class="language-php">use App\Ldap\User;

public class UsersController extends Controller
{
    public function index()
    {
        $users = User::get();

        return view('ldap.users', ['users' =&gt; $users]);
    }
}
</code></pre>

<p>And our view that simply lists all the users:</p>

<pre><code class="language-html">&lt;table&gt;
    &lt;thead&gt;
        &lt;tr&gt;
            &lt;th&gt;Username&lt;/th&gt;      
            &lt;th&gt;Full Name&lt;/th&gt;      
        &lt;/tr&gt;
    &lt;/thead&gt;
    &lt;tbody&gt;
        @foreach($users as $user)
            &lt;tr&gt;
                 &lt;td&gt;{{ $user-&gt;getFirstAttribute('samaccountname') }}&lt;/td&gt;       
                 &lt;td&gt;{{ $user-&gt;getFirstAttribute('cn') }}&lt;/td&gt;       
            &lt;/tr&gt;
        @endforeach
    &lt;/tbody&gt;
&lt;/table&gt;
</code></pre>

<p>To test this would involve a ton of mocking - which we want to avoid. With the Directory Emulator,
we can populate a fake LDAP server with objects utilizing our actual connection configuration.</p>

<p>Let's create a test for the <code>UserController@index</code> method. We'll create a Laravel test running the following command:</p>

<pre><code class="language-bash">php artisan make:test LdapUserControllerTest
</code></pre>

<p>Now that we have our test, let's attempt to test our <code>index</code> method:</p>

<pre><code class="language-php">use App\Ldap\User;
use LdapRecord\Laravel\Testing\DirectoryEmulator;

class LdapUserControllerTest extends TestCase
{
    public function test_index_works()
    {
        DirectoryEmulator::setup('default');

        $user = User::create([
            'cn' =&gt; 'John Doe',
            'samaccountname' =&gt; 'jdoe',
        ]);

        $this-&gt;assertEquals('cn=John Doe,dc=local,dc=com', $user-&gt;getDn());

        $this-&gt;visit('/ldap/users')
            -&gt;assertSee($user-&gt;getFirstAttribute('cn'))
            -&gt;assertSee($user-&gt;getFirstAttribute('samaccountname'));
    }
}
</code></pre>

<p>As with actual LDAP objects created in a live directory using LdapRecord models, when you create
LDAP objects in the emulated directory, they will use your connections configured <code>base_dn</code>
to create distinguished names.</p>

<h2 id="sqlite-file-database">Using a SQLite File Database</h2>

<p>To use a SQLite file database, you must supply an array to the second parameter
of the <code>DirectoryEmulator::setup</code> method and provide a file path using the 
<code>database</code> key where you would like the SQLite file to be stored:</p>

<blockquote>
  <p>If the file does not exist already, it will be created for you automatically.</p>
</blockquote>

<pre><code class="language-php">$file = storage_path('ldap_test_database.sqlite');

DirectoryEmulator::setup('default', ['database' =&gt; $file]);
</code></pre>

<h2 id="emulated-queries">Emulated Queries</h2>

<p>The Directory Emulator also emulates LDAP queries. However, there are limitations. The
following features are not supported using the emulator:</p>

<ul>
<li><code>raw</code> filters</li>
<li><code>anr</code> (Ambiguous Name Resolution) filters</li>
<li>Virtual attributes (such as <code>memberof</code>, <code>entryUUID</code> and more)</li>
</ul>

<blockquote>
  <p>You must use LdapRecord models to perform queries. You cannot use a plain LdapRecord <code>Connection</code> to retrieve objects.</p>
</blockquote>

<p>Using the emulator, you can create a diverse LDAP object tree in your unit tests and ensure your
application is querying the proper objects.</p>

<p>Let's update our example controller to retrieve users inside of a specific OU and a company name:</p>

<pre><code class="language-php">public class UsersController extends Controller
{
    public function index()
    {
        $ou = OrganizationalUnit::find('ou=Accounting,dc=local,dc=com');

        $users = User::in($ou)-&gt;where('company', '=', 'Acme')-&gt;get();

        return view('ldap.users', ['users' =&gt; $users]);
    }
}
</code></pre>

<p>Now we can update our test by creating an Organizational Unit and then creating a user
inside of that OU and assert that we only see the proper user:</p>

<pre><code class="language-php">public function test_index_works()
{
    DirectoryEmulator::setup('default');

    $user = User::create([
        'cn' =&gt; 'John Doe',
        'samaccountname' =&gt; 'johndoe',
    ]);

    $ou = OrganizationalUnit::create([
        'ou' =&gt; 'Accounting',
    ]);

    $accountant = (new User)-&gt;inside($ou)-&gt;save([
        'cn' =&gt; 'Jane Doe',
        'samaccountname' =&gt; 'janedoe',
    ]);

    $this-&gt;visit('/ldap/users')
        -&gt;assertSee($accountant-&gt;getFirstAttribute('cn'))
        -&gt;assertSee($accountant-&gt;getFirstAttribute('samaccountname'))
        -&gt;assertDontSee($user-&gt;getFirstAttribute('cn'))
        -&gt;assertDontSee($user-&gt;getFirstAttribute('samaccountname'));
}
</code></pre>

<p>As you can see, this is extremely effective for testing your LDAP query integrations.</p>

<h2 id="working-with-relationships">Working with Relationships</h2>

<h3>Has One</h3>

<p>A <code>hasOne</code> relationship is easy to test. In this example, we will set the <code>manager</code> of another user:</p>

<pre><code class="language-php">$manager = User::create(['cn' =&gt; 'John']);
$user = User::create(['cn' =&gt; 'Jane']);

$user-&gt;manager()-&gt;attach($manager);
</code></pre>

<p>Then, you can retrieve the users manager:</p>

<pre><code class="language-php">$manager = $user-&gt;manager()-&gt;first();
</code></pre>

<h3>Has Many</h3>

<p>Since some attributes are virtual in LDAP (such as the the <code>memberof</code> attribute on User
objects in Active Directory), you will have to populate some attributes manually
to mimic these virtual attributes. Let's walk through an example.</p>

<p>In our application, we want to test that a user is a member of a particular group.</p>

<p>First, we will create our group and user and add the user to the group:</p>

<pre><code class="language-php">$group = Group::create(['cn' =&gt; 'Accounting']);

$user = User::create(['cn' =&gt; 'John']);

$user-&gt;groups()-&gt;attach($group);
</code></pre>

<p>Now, if we attempt to retrieve the <code>$group-&gt;members()</code> relationship, we won't receive
any results, but we will when using the <code>$user-&gt;groups()</code> relationship:</p>

<pre><code class="language-php">// Empty collection returned!
$users = $group-&gt;members()-&gt;get();

// A collection containing 'Accounting' group returned.
$groups = $user-&gt;groups()-&gt;get();
</code></pre>

<p>The <code>$user-&gt;groups()</code> relationship works because it queries for groups that contain a <code>member</code>
attribute equal to the users distinguished name. This <code>member</code> attribute is set on the 
<code>$group</code> instance that you pass into the <code>attach()</code> method.</p>

<p>The <code>$group-&gt;members()</code> relationship <strong>does not work</strong> because it queries for objects that contain
a <code>memberof</code> attribute to locate objects that are members. The <code>memberof</code> attribute is virtual,
so we must populate it manually to get our relationships working on both directions:</p>

<pre><code class="language-php">$group = Group::create(['cn' =&gt; 'Accounting']);

$user = User::create([
    'cn' =&gt; 'John',
    'memberof' =&gt; [$group-&gt;getDn()],
]);

$user-&gt;groups()-&gt;attach($group);

// Returns the user 'John'.
$users = $group-&gt;members()-&gt;first();

// Returns 'Accounting' group.
$groups = $user-&gt;groups()-&gt;first();
</code></pre>

<h3>Has Many In</h3>

<p>Similarly with the <code>hasMany</code> relationship, when using a <code>hasManyIn</code> relationship,
you must pre-populate a users virtual attribute for queries to properly locate
members of a group.</p>

                <div class="mt-12 pt-8 pb-6 border-t-2">
                        <div class="flex flex-col-reverse md:flex-row justify-between items-center">
    <div class="flex flex-col items-center md:items-start">
                    <span class="font-black text-gray-500 text-sm tracking-wider uppercase pb-1">← Previous Topic</span>
            <h4 class="font-bold underline m-0 text-blue-700">
                <a href="/docs/laravel/importing">Importing Objects</a>
            </h4>
            </div>
    <div class="mb-8 md:mb-0 flex flex-col items-center md:items-end">
                    <span class="font-black text-gray-500 text-sm tracking-wider uppercase pb-1">Next Topic →</span>
            <h4 class="font-bold underline m-0 text-blue-700">
                <a href="/docs/laravel/debugging">Debugging</a>
            </h4>
            </div>
</div>
                </div>
            </div>
        </div>
    </section>
        </main>

        <script src="/assets/build/js/main.js?id=4084d289e77efba0f3a9"></script>

        <script>
    const navMenu = {
        toggle() {
            const menu = document.getElementById('js-nav-menu');
            menu.classList.toggle('hidden');
            menu.classList.toggle('lg:block');
            document.getElementById('js-nav-menu-hide').classList.toggle('hidden');
            document.getElementById('js-nav-menu-show').classList.toggle('hidden');
        },
    }
</script>
            <script type="text/javascript">
            docsearch({
                apiKey: 'bc526397341486f980ca0b7ee7a0fa61',
                indexName: 'ldaprecord',
                inputSelector: '#docsearch-input',
                debug: false // Set debug to true if you want to inspect the dropdown
            });

            const searchInput = {
                toggle() {
                    const menu = document.getElementById('js-search-input');
                    menu.classList.toggle('hidden');
                    menu.classList.toggle('md:block');
                    document.getElementById('docsearch-input').focus();
                },
            }
        </script>
    
        <footer class="text-center text-sm mt-12 py-4 mt-auto" role="contentinfo">
            <ul class="flex flex-col md:flex-row justify-center list-none">
                <li class="md:mr-2">
                    &copy; <a href="https://github.com/DirectoryTree" title="DirectoryTree GitHub">DirectoryTree</a> 2020.
                </li>

                <li class="md:mr-2">
                    Built with <a href="http://jigsaw.tighten.co" title="Jigsaw by Tighten">Jigsaw</a>
                    and <a href="https://tailwindcss.com" title="Tailwind CSS, a utility-first CSS framework">Tailwind CSS</a>.
                </li>
            </ul>
        </footer>
    </body>
</html>
